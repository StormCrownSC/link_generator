<!DOCTYPE html>
<html>
<head>
    <title>Link generator</title>
</head>
<body>
<form id="shorten-form" method="post" enctype="application/x-www-form-urlencoded">
    <p>Сгененрировать короткую ссылку</p>
    <input type="text" id="url" name="url"/>
    <input type="submit" id="subshot"/>

</form>

<p id="resultsh"></p><br/>
<form id="long-form" method="get" enctype="application/x-www-form-urlencoded">
    <p>Получить полную ссылку</p>
    <input type="text" id="shot_url" name="shot_url"/>
    <input type="submit" id="sublong"/>

</form>

<p id="resultlong"></p><br/>
<form id="all-link-form" method="get" enctype="application/x-www-form-urlencoded">
    <p>Получить все ссылки</p>
    <input type="submit" id="suball"></input>
</form>
<p id="resultall"></p><br/>

<form id="del-link-form" method="get" enctype="application/x-www-form-urlencoded">
    <p>Ввведите полную ссылку для удаления из бд</p>
    <input type="text" id="del_url" name="full_url"/>
    <input type="submit" id="subdel"></input>
</form>

<script>
     const form = document.querySelector('#shorten-form');
    const resultsh = document.querySelector('#resultsh');

    const { RSocketClient } = require('rsocket-core');
    const RSocketWebsocketClient = require('rsocket-websocket-client').default;
    const WebSocket = require('ws');

    function now() {
        return new Date().getTime();
    }

    async function connect(options) {
        const transportOptions = {
            url: 'ws://127.0.0.1:9898',
            wsCreator: (url) => {
                return new WebSocket(url);
            },
        };
        const setup = {
            keepAlive: 1000000,
            lifetime: 100000,
            dataMimeType: 'text/plain',
            metadataMimeType: 'text/plain',
        };
        const transport = new RSocketWebsocketClient(transportOptions);
        const client = new RSocketClient({ setup, transport });
        return await client.connect();
    }

    form.addEventListener('submit', async (event) => {
        var url = document.getElementById("url").value;
        event.preventDefault();
        const rsocket = await connect();
        const start = now();
        const interval = setInterval(() => {
            rsocket.requestResponse({ data: url }).subscribe({
                onComplete: (response) => {
                    resultsh.innerHTML = "<a href='" + url + "'>" + response.data + "  </a>";
                    console.log(response);
                },
                onError: (error) => {
                    console.error(error);
                },
                onSubscribe: (cancel) => {
                    /* call cancel() to stop onComplete/onError */
                },
            });

        }, );
    });

    const longform = document.querySelector('#long-form');
    const resultlong = document.querySelector('#resultlong');

    longform.addEventListener('submit', async (event) => {
        var shot_url = document.getElementById("shot_url").value;
        event.preventDefault();
        const response = await fetch('http://localhost:11000/shorten?shortlink=' + shot_url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
        });
        const data = await response.json();
        resultlong.innerHTML = "<a href='" + data.Link + "'>" + data.Link + " </a>";
        console.log(data)
    });
</script>
</body>
</html>